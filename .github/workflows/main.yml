import yfinance as yf
from datetime import datetime

def get_market_data():
    symbols = {
        '^GSPC': 'æ ‡æ™®500',
        '^IXIC': 'çº³æ–¯è¾¾å…‹',
        'BTC-USD': 'æ¯”ç‰¹å¸',
        'NVDA': 'è‹±ä¼Ÿè¾¾',
        'TSLA': 'ç‰¹æ–¯æ‹‰',
        'AAPL': 'è‹¹æœ',
        'GC=F': 'é»„é‡‘æœŸè´§'
    }
    
    report_items = []
    for sym, name in symbols.items():
        try:
            ticker = yf.Ticker(sym)
            hist = ticker.history(period='2d')
            if len(hist) < 2: continue
            
            prev_close = hist['Close'].iloc[-2]
            curr_close = hist['Close'].iloc[-1]
            change_pct = ((curr_close - prev_close) / prev_close) * 100
            
            # æŠ“å–ç›¸å…³æ–°é—»
            news_text = ""
            if abs(change_pct) > 1: # åªè¦æ³¢åŠ¨è¶…è¿‡1%å°±æŠ“æ–°é—»
                raw_news = ticker.news[:2] # å–æœ€æ–°çš„2æ¡æ–°é—»
                for n in raw_news:
                    news_text += f"â€¢ {n['title']}<br/>"
            
            status = "ğŸš€" if change_pct > 2 else "ğŸ”»" if change_pct < -2 else "ç›˜æ•´"
            
            report_items.append({
                'name': name,
                'price': round(curr_close, 2),
                'change': round(change_pct, 2),
                'status': status,
                'news': news_text
            })
        except:
            continue
            
    return report_items

def generate_html(items):
    now = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    
    # å¼‚åŠ¨å±•ç¤ºåŒº
    movers_html = ""
    for i in items:
        if abs(i['change']) >= 2: # å¼‚åŠ¨é˜ˆå€¼è®¾å®šä¸º2%
            color = "text-green-400" if i['change'] > 0 else "text-red-400"
            border = "border-green-500" if i['change'] > 0 else "border-red-500"
            movers_html += f"""
            <div class="p-4 bg-gray-800 rounded-xl mb-4 border-l-4 {border}">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xl font-bold text-white">{i['name']}</span>
                    <span class="{color} font-bold">{i['change']}% {i['status']}</span>
                </div>
                <p class="text-gray-400 text-sm leading-relaxed">
                    {i['news'] if i['news'] else "â€¢ æš‚æ— çªå‘æ–°é—»äº‹ä»¶æŠ¥å‘Š"}
                </p>
            </div>
            """

    # æ ¸å¿ƒæ•°æ®ç½‘æ ¼
    grid_html = "".join([
        f'<div class="bg-gray-800 p-3 rounded-lg border border-gray-700">'
        f'<div class="text-gray-400 text-xs">{i["name"]}</div>'
        f'<div class="text-white font-bold">${i["price"]}</div>'
        f'<div class="{"text-green-400" if i["change"]>0 else "text-red-400"} text-xs">{i["change"]}%</div>'
        f'</div>' for i in items
    ])

    html_template = f"""
    <!DOCTYPE html>
    <html lang="zh">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AI é‡‘èæ—©æŠ¥</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>body {{ background-color: #111827; }}</style>
    </head>
    <body class="p-4 text-gray-200 font-sans">
        <div class="max-w-md mx-auto">
            <header class="mb-8 mt-4">
                <h1 class="text-3xl font-black text-white italic">FINANCE <span class="text-yellow-500">AI</span></h1>
                <p class="text-gray-500 text-xs uppercase tracking-widest">Last Update: {now}</p>
            </header>

            <section class="mb-8">
                <h2 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-widest flex items-center">
                    <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span> å¼‚åŠ¨äº‹ä»¶è§£æ
                </h2>
                {movers_html if movers_html else '<p class="text-gray-600 italic">ä»Šæ—¥å¸‚åœºæš‚æ— å‰§çƒˆå¼‚åŠ¨</p>'}
            </section>

            <section>
                <h2 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-widest">å¸‚åœºè¡Œæƒ…æ¦‚è§ˆ</h2>
                <div class="grid grid-cols-2 gap-3">
                    {grid_html}
                </div>
            </section>

            <footer class="mt-12 mb-8 text-center text-gray-600 text-xs">
                æ•°æ®æ¥æº: Yahoo Finance API<br/>ç”± AI Agent è‡ªåŠ¨é©±åŠ¨ç”Ÿæˆ
            </footer>
        </div>
    </body>
    </html>
    """
    
    with open("index.html", "w", encoding="utf-8") as f:
        f.write(html_template)

if __name__ == "__main__":
    data = get_market_data()
    generate_html(data)
